<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Simple Pitch Training Debug</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        .log {
            background: #001100;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            color: #f00;
        }
        .warning {
            color: #fa0;
        }
        .info {
            color: #0ff;
        }
        .success {
            color: #0f0;
        }
        button {
            background: #333;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Simple Pitch Training Debug Console</h1>
    
    <div>
        <button onclick="testMicrophoneManager()">ğŸ¤ Test MicrophoneManager</button>
        <button onclick="testPitchDetector()">ğŸµ Test PitchDetector</button>
        <button onclick="testNoiseReduction()">ğŸ”Š Test NoiseReduction</button>
        <button onclick="clearLogs()">ğŸ§¹ Clear Logs</button>
    </div>
    
    <div id="logs" class="log"></div>
    
    <script>
        // ãƒ­ã‚°å‡ºåŠ›ã‚·ã‚¹ãƒ†ãƒ 
        const logDiv = document.getElementById('logs');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            const div = document.createElement('div');
            div.className = type;
            div.textContent = logEntry;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // å…ƒã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
            if (type === 'error') {
                originalError(message);
            } else if (type === 'warning') {
                originalWarn(message);
            } else {
                originalLog(message);
            }
        }
        
        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯
        console.log = (...args) => addLog(args.join(' '), 'info');
        console.error = (...args) => addLog(args.join(' '), 'error');
        console.warn = (...args) => addLog(args.join(' '), 'warning');
        
        function clearLogs() {
            logDiv.innerHTML = '';
        }
        
        // ãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testMicrophoneManager() {
            addLog('ğŸ¤ MicrophoneManager ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                // MicrophoneManagerã‚¯ãƒ©ã‚¹ã®å­˜åœ¨ç¢ºèª
                if (typeof MicrophoneManager === 'undefined') {
                    addLog('âŒ MicrophoneManager ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                const mic = new MicrophoneManager();
                addLog('âœ… MicrophoneManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå®Œäº†', 'success');
                
                // åˆæœŸçŠ¶æ…‹ç¢ºèª
                addLog(`ğŸ” noiseReduction.enabled: ${mic.noiseReduction.enabled}`, 'info');
                addLog(`ğŸ” isActive: ${mic.isActive}`, 'info');
                
                // ãƒã‚¤ã‚¯è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                addLog('ğŸ“ ãƒã‚¤ã‚¯è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹', 'info');
                await mic.requestAccess();
                addLog('âœ… ãƒã‚¤ã‚¯è¨±å¯å®Œäº†', 'success');
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ç¢ºèª
                addLog(`ğŸ” highPassFilter: ${!!mic.noiseReduction.highPassFilter}`, 'info');
                addLog(`ğŸ” lowPassFilter: ${!!mic.noiseReduction.lowPassFilter}`, 'info');
                addLog(`ğŸ” notchFilter: ${!!mic.noiseReduction.notchFilter}`, 'info');
                addLog(`ğŸ” gainNode: ${!!mic.noiseReduction.gainNode}`, 'info');
                
                // AudioContextçŠ¶æ…‹ç¢ºèª
                addLog(`ğŸ” audioContext.state: ${mic.audioContext.state}`, 'info');
                addLog(`ğŸ” audioContext.sampleRate: ${mic.audioContext.sampleRate}`, 'info');
                
                // åœæ­¢
                setTimeout(() => {
                    mic.stop();
                    addLog('ğŸ›‘ ãƒã‚¤ã‚¯åœæ­¢å®Œäº†', 'info');
                }, 3000);
                
            } catch (error) {
                addLog(`âŒ MicrophoneManager ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        async function testPitchDetector() {
            addLog('ğŸµ PitchDetector ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                if (typeof PitchDetectionManager === 'undefined') {
                    addLog('âŒ PitchDetectionManager ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                const detector = new PitchDetectionManager();
                addLog('âœ… PitchDetectionManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå®Œäº†', 'success');
                
                // AudioContextä½œæˆ
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                addLog('âœ… AudioContextä½œæˆå®Œäº†', 'success');
                
                // åˆæœŸåŒ–
                await detector.initialize(audioContext);
                addLog('âœ… PitchDetector åˆæœŸåŒ–å®Œäº†', 'success');
                
                // ãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
                const testData = new Float32Array(2048);
                for (let i = 0; i < testData.length; i++) {
                    testData[i] = Math.sin(2 * Math.PI * 440 * i / 48000) * 0.5;
                }
                
                const pitch = detector.detectPitch(testData);
                addLog(`ğŸ¯ ãƒ†ã‚¹ãƒˆéŸ³ç¨‹æ¤œå‡ºçµæœ: ${pitch ? pitch.toFixed(2) + 'Hz' : 'null'}`, 'info');
                
                audioContext.close();
                
            } catch (error) {
                addLog(`âŒ PitchDetector ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        async function testNoiseReduction() {
            addLog('ğŸ”Š NoiseReduction ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                addLog('âœ… AudioContextä½œæˆå®Œäº†', 'success');
                
                // ãƒã‚¤ã‚ºãƒªãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ‰‹å‹•ä½œæˆ
                const highPassFilter = audioContext.createBiquadFilter();
                highPassFilter.type = 'highpass';
                highPassFilter.frequency.setValueAtTime(80, audioContext.currentTime);
                highPassFilter.Q.setValueAtTime(0.7, audioContext.currentTime);
                addLog('âœ… HighPassFilterä½œæˆå®Œäº†', 'success');
                
                const lowPassFilter = audioContext.createBiquadFilter();
                lowPassFilter.type = 'lowpass';
                lowPassFilter.frequency.setValueAtTime(2000, audioContext.currentTime);
                lowPassFilter.Q.setValueAtTime(0.7, audioContext.currentTime);
                addLog('âœ… LowPassFilterä½œæˆå®Œäº†', 'success');
                
                const notchFilter = audioContext.createBiquadFilter();
                notchFilter.type = 'notch';
                notchFilter.frequency.setValueAtTime(60, audioContext.currentTime);
                notchFilter.Q.setValueAtTime(30, audioContext.currentTime);
                addLog('âœ… NotchFilterä½œæˆå®Œäº†', 'success');
                
                const gainNode = audioContext.createGain();
                gainNode.gain.setValueAtTime(1.2, audioContext.currentTime);
                addLog('âœ… GainNodeä½œæˆå®Œäº†', 'success');
                
                // ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ä½œæˆ
                const analyzer = audioContext.createAnalyser();
                analyzer.fftSize = 2048;
                analyzer.smoothingTimeConstant = 0.3;
                addLog('âœ… Analyzerä½œæˆå®Œäº†', 'success');
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚§ãƒ¼ãƒ³æ¥ç¶šãƒ†ã‚¹ãƒˆ
                const oscillator = audioContext.createOscillator();
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                
                // ãƒã‚§ãƒ¼ãƒ³æ¥ç¶š
                oscillator.connect(highPassFilter);
                highPassFilter.connect(lowPassFilter);
                lowPassFilter.connect(notchFilter);
                notchFilter.connect(gainNode);
                gainNode.connect(analyzer);
                analyzer.connect(audioContext.destination);
                
                addLog('âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚§ãƒ¼ãƒ³æ¥ç¶šå®Œäº†', 'success');
                
                // çŸ­æ™‚é–“ãƒ†ã‚¹ãƒˆéŸ³å†ç”Ÿ
                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                    addLog('ğŸ”Š ãƒ†ã‚¹ãƒˆéŸ³å†ç”Ÿå®Œäº†', 'info');
                }, 500);
                
                setTimeout(() => {
                    audioContext.close();
                    addLog('ğŸ›‘ AudioContextçµ‚äº†', 'info');
                }, 1000);
                
            } catch (error) {
                addLog(`âŒ NoiseReduction ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        // è‡ªå‹•ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿
        async function loadLibraries() {
            addLog('ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿é–‹å§‹', 'info');
            
            try {
                // Tone.jsèª­ã¿è¾¼ã¿
                const toneScript = document.createElement('script');
                toneScript.src = 'tone.js';
                document.head.appendChild(toneScript);
                
                await new Promise((resolve, reject) => {
                    toneScript.onload = resolve;
                    toneScript.onerror = reject;
                });
                addLog('âœ… Tone.jsèª­ã¿è¾¼ã¿å®Œäº†', 'success');
                
                // Pitchyèª­ã¿è¾¼ã¿
                const { PitchDetector } = await import("https://esm.sh/pitchy@4");
                window.PitchDetector = PitchDetector;
                addLog('âœ… Pitchyèª­ã¿è¾¼ã¿å®Œäº†', 'success');
                
                // ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿
                const mainScript = document.createElement('script');
                mainScript.src = 'simple-pitch-training.js';
                document.head.appendChild(mainScript);
                
                await new Promise((resolve, reject) => {
                    mainScript.onload = resolve;
                    mainScript.onerror = reject;
                });
                addLog('âœ… simple-pitch-training.jsèª­ã¿è¾¼ã¿å®Œäº†', 'success');
                
            } catch (error) {
                addLog(`âŒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', loadLibraries);
    </script>
</body>
</html>