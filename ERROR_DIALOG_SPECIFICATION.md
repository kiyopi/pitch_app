# 標準エラーダイアログ仕様書

**作成日**: 2025-07-15  
**対象**: Simple Pitch Training アプリケーション  
**仕様レベル**: 実装必須  

---

## 🎯 基本方針

### 設計原則
- **確実性優先**: 必ず表示される標準ダイアログを使用
- **自動復旧**: confirm()でリロード選択肢を提供
- **ユーザビリティ**: 簡潔で分かりやすいメッセージ

### 実装方針
- **alert()**: 情報提供のみ（OK押下後、手動操作が必要）
- **confirm()**: 自動リロード選択肢付き（推奨）
- **自動リロード**: `location.reload()` で即座に復旧

---

## 📋 エラーケース一覧

### 🎤 マイク関連エラー

#### 1. 初期化時マイク拒否
**発生タイミング**: ページ読み込み時のgetUserMedia()呼び出し  
**エラー名**: `NotAllowedError`  
**対応**: 情報提供のみ（手動設定変更が必要）

```javascript
// 実装コード
alert('マイクの使用が許可されていません。\n\nブラウザの設定でマイクアクセスを許可してから、ページを再読み込みしてください。');
```

**メッセージ内容**:
- 問題の説明：マイク許可が必要
- 解決方法：ブラウザ設定変更
- 次のアクション：手動リロード

#### 2. マイク未接続
**発生タイミング**: デバイス検出時  
**エラー名**: `NotFoundError`  
**対応**: リロード選択肢付き

```javascript
// 実装コード
if (confirm('マイクが見つかりません。\n\nマイクを接続してから再読み込みしますか？')) {
    location.reload();
}
```

**メッセージ内容**:
- 問題の説明：マイクデバイス未検出
- 解決方法：マイク接続
- 次のアクション：リロード選択

#### 3. マイク使用中
**発生タイミング**: 他アプリケーションがマイク使用中  
**エラー名**: `NotReadableError`  
**対応**: リロード選択肢付き

```javascript
// 実装コード
if (confirm('マイクが他のアプリケーションで使用されています。\n\n他のアプリを終了してから再読み込みしますか？')) {
    location.reload();
}
```

**メッセージ内容**:
- 問題の説明：マイクリソース競合
- 解決方法：他アプリ終了
- 次のアクション：リロード選択

#### 4. マイク不許可後スタート
**発生タイミング**: 事前準備失敗後のスタートボタン押下  
**エラー判定**: `this.isReady === false`  
**対応**: リロード選択肢付き

```javascript
// 実装コード
if (confirm('マイクの準備ができていません。\n\nページを再読み込みしてマイクを許可しますか？')) {
    location.reload();
}
```

**メッセージ内容**:
- 問題の説明：事前準備未完了
- 解決方法：マイク許可
- 次のアクション：リロード選択

#### 5. マイク途中切断
**発生タイミング**: 使用中のマイク接続切断  
**検出方法**: stream.getTracks()の状態監視  
**対応**: リロード選択肢付き

```javascript
// 実装コード
if (confirm('マイクの接続が切れました。\n\nページを再読み込みしますか？')) {
    location.reload();
}
```

**メッセージ内容**:
- 問題の説明：マイク接続切断
- 解決方法：リロード
- 次のアクション：リロード選択

### 🔧 技術的エラー

#### 6. Pitchy初期化失敗
**発生タイミング**: PitchDetector.forFloat32Array()呼び出し時  
**エラー例**: `TypeError: this._bufferSupplier is not a function`  
**対応**: リロード選択肢付き

```javascript
// 実装コード
if (confirm('音程検出の初期化に失敗しました。\n\nページを再読み込みしますか？')) {
    location.reload();
}
```

#### 7. AudioContext生成失敗
**発生タイミング**: new AudioContext()呼び出し時  
**原因**: ブラウザ制限、リソース不足  
**対応**: リロード選択肢付き

```javascript
// 実装コード
if (confirm('音声処理の初期化に失敗しました。\n\nページを再読み込みしますか？')) {
    location.reload();
}
```

#### 8. Tone.js読み込み失敗
**発生タイミング**: tone.js読み込み時  
**検出方法**: `!window.Tone`  
**対応**: リロード選択肢付き

```javascript
// 実装コード
if (confirm('音声合成ライブラリの読み込みに失敗しました。\n\nページを再読み込みしますか？')) {
    location.reload();
}
```

#### 9. ブラウザ非対応
**発生タイミング**: 古いブラウザでの機能チェック  
**検出方法**: `!navigator.mediaDevices`  
**対応**: 情報提供のみ

```javascript
// 実装コード
alert('お使いのブラウザはマイク機能に対応していません。\n\nChrome、Firefox、Safari の最新版をご使用ください。');
```

### 🌐 ネットワーク関連

#### 10. GitHub Pages接続失敗
**発生タイミング**: 基音再生時のTone.js動作エラー  
**対応**: リロード選択肢付き

```javascript
// 実装コード
if (confirm('基音再生に失敗しました。\n\nインターネット接続を確認してから再読み込みしますか？')) {
    location.reload();
}
```

#### 11. Pitchyライブラリ404
**発生タイミング**: ESM import失敗  
**検出方法**: `!window.PitchDetector`  
**対応**: リロード選択肢付き

```javascript
// 実装コード
if (confirm('音程検出ライブラリの読み込みに失敗しました。\n\nインターネット接続を確認してから再読み込みしますか？')) {
    location.reload();
}
```

---

## 🔧 実装ガイドライン

### エラーハンドリング統一形式

#### 1. エラー検出
```javascript
try {
    // 処理実行
} catch (error) {
    handleError(error);
}
```

#### 2. エラー分類
```javascript
function handleError(error) {
    switch (error.name) {
        case 'NotAllowedError':
            showMicrophonePermissionError();
            break;
        case 'NotFoundError':
            showMicrophoneNotFoundError();
            break;
        case 'NotReadableError':
            showMicrophoneInUseError();
            break;
        default:
            showGenericError(error);
    }
}
```

#### 3. 標準ダイアログ表示
```javascript
function showMicrophonePermissionError() {
    alert('マイクの使用が許可されていません。\n\nブラウザの設定でマイクアクセスを許可してから、ページを再読み込みしてください。');
}
```

### リロード機能実装

#### 確認付きリロード
```javascript
function confirmReload(message) {
    if (confirm(message)) {
        location.reload();
    }
}
```

#### 使用例
```javascript
confirmReload('マイクが見つかりません。\n\nマイクを接続してから再読み込みしますか？');
```

---

## 🧪 テスト仕様

### 手動テスト項目

#### マイク関連テスト
- [ ] マイク拒否時のエラー表示
- [ ] マイク未接続時のエラー表示
- [ ] マイク使用中エラーの表示
- [ ] 事前準備失敗後のスタートボタン押下
- [ ] マイク途中切断時の検出

#### 技術的エラーテスト
- [ ] Pitchy初期化失敗の再現
- [ ] AudioContext生成失敗の再現
- [ ] Tone.js読み込み失敗の再現
- [ ] ブラウザ非対応環境での動作

#### ネットワークエラーテスト
- [ ] オフライン時の動作
- [ ] CDN接続失敗時の動作

### 自動テスト（将来実装）

#### ユニットテスト
```javascript
describe('Error Dialog', () => {
    it('should show microphone permission error', () => {
        // テスト実装
    });
});
```

---

## 📝 修正履歴

### v1.0.0 (2025-07-15)
- 初版作成
- 11のエラーケース定義
- 標準ダイアログ実装方針確立

### 今後の予定
- 実装完了後のテスト結果反映
- 新しいエラーケースの追加
- メッセージ内容の最適化

---

## 🚨 重要事項

### 必須チェック項目
- [ ] エラーメッセージは簡潔で分かりやすいか？
- [ ] confirm()でリロード選択肢を提供しているか？
- [ ] alert()は手動操作が必要な場合のみ使用しているか？

### 禁止事項
- ❌ 独自エラーダイアログの使用
- ❌ エラー時の自動リロード（confirm無し）
- ❌ 技術的すぎるエラーメッセージ

### 推奨事項
- ✅ confirm() + location.reload() の組み合わせ
- ✅ ユーザー目線の分かりやすいメッセージ
- ✅ 具体的な解決手順の提示

---

**この仕様書は実装の必須参照文書です。エラーハンドリング修正時は必ず参照してください。**

*最終更新: 2025-07-15*  
*レビュー予定: 実装完了後*